sudo: false
language: generic
os:
  - linux

env:
  global:
    - PYENV_VERSION=3.7

stages:
  - test
  - name: website_release
    if: branch = master
  - name: website_dev
    if: (commit_message =~ /^.*(website_dev).*$/) OR (branch = master)

jobs:
  include:
    - &test
      stage: test
      before_install:
        - pip install pyctdev && doit miniconda_install
        - export PATH="$HOME/miniconda/bin:$PATH" && hash -r
        - doit ecosystem_setup
      install:
        - doit env_create
        - source activate pyviz
        - doit env_capture
      script:
        - if ! [ $(ls -A ./notebooks/**/*.ipynb) ]; then
            echo 'No notebooks found' && exit 0;
          fi;
        - doit test_all

    - &website_release
      <<: *test
      stage: website_release
      env: BUILD_CACHE=True
      script:
        # these steps can be called using doit build_cache
        # but the Travis job will time out, so they are split up here
        - python tools/conda_downloads.py
        - SECTION="Core" python tools/build_cache.py
        - SECTION="High-Level Shared API" python tools/build_cache.py
        - SECTION="High-Level" python tools/build_cache.py
        - SECTION="Native-GUI" python tools/build_cache.py
        - SECTION="Other InfoVis" python tools/build_cache.py
        - SECTION="SciVis" python tools/build_cache.py
        - SECTION="Geospatial" python tools/build_cache.py
        - SECTION="Other domain-specific" python tools/build_cache.py
        - SECTION="Large-data rendering" python tools/build_cache.py
        - SECTION="Dashboarding" python tools/build_cache.py
        - SECTION="Colormapping" python tools/build_cache.py
        - SECTION="Dormant projects" python tools/build_cache.py
        - doit build_website
      deploy:
        - provider: pages
          skip_cleanup: true
          github_token: $GITHUB_TOKEN
          local_dir: ./builtdocs
          fqdn: pyviz.org
          on:
            all_branches: true

    - <<: *website_release
      stage: website_dev
      deploy:
        - provider: pages
          skip_cleanup: true
          github_token: $GITHUB_TOKEN
          local_dir: ./builtdocs
          repo: pyviz-dev/website
          on:
            all_branches: true
